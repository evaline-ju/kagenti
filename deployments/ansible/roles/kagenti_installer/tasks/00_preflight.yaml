# Preflight checks for Kind cluster creation
# Validates that the container runtime has sufficient resources (memory, CPU)
# before attempting to create a Kind cluster. Prevents hard-to-diagnose failures
# like cert-manager crashes or Istio pods stuck pending due to insufficient resources.
#
# See: https://github.com/kagenti/kagenti/issues/724

- name: Preflight - Get container runtime info (Docker)
  command: docker info --format "{{ '{{' }}.MemTotal{{ '}}' }},{{ '{{' }}.NCPU{{ '}}' }}"
  register: docker_info
  failed_when: false
  changed_when: false
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))
    - container_engine | default('docker') == 'docker'

- name: Preflight - Get container runtime info (Podman)
  command: podman info --format "{{ '{{' }}.Host.MemTotal{{ '}}' }},{{ '{{' }}.Host.CPUs{{ '}}' }}"
  register: podman_info
  failed_when: false
  changed_when: false
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))
    - container_engine | default('docker') == 'podman'

- name: Preflight - Set runtime info facts
  set_fact:
    runtime_info: "{{ docker_info if (container_engine | default('docker')) == 'docker' else podman_info }}"
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))

- name: Preflight - Fail if container runtime is not available
  fail:
    msg: >-
      Container runtime '{{ container_engine | default('docker') }}' is not available or not running.
      Please start {{ container_engine | default('docker') }} and try again.
      Error: {{ runtime_info.stderr | default('unknown error') }}
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))
    - runtime_info.rc | default(1) != 0

- name: Preflight - Parse container runtime resources
  set_fact:
    runtime_memory_bytes: "{{ (runtime_info.stdout | default('0,0')).split(',')[0] | int }}"
    runtime_cpus: "{{ (runtime_info.stdout | default('0,0')).split(',')[1] | int }}"
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))
    - runtime_info.rc | default(1) == 0

- name: Preflight - Calculate memory in GB
  set_fact:
    runtime_memory_gb: "{{ (runtime_memory_bytes | int / 1000000000) | round(1) }}"
    runtime_memory_mb: "{{ (runtime_memory_bytes | int / 1000000) | int }}"
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))
    - runtime_memory_bytes is defined

- name: Preflight - Display container runtime resources
  debug:
    msg: >-
      Container runtime '{{ container_engine | default('docker') }}':
      Memory={{ runtime_memory_gb }}GB ({{ runtime_memory_mb }}MB, minimum: {{ kind_min_memory_gb }}GB),
      CPUs={{ runtime_cpus }} (minimum: {{ kind_min_cpus }})
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))
    - runtime_memory_gb is defined

- name: Preflight - Fail if container runtime has insufficient memory
  fail:
    msg: >-
      Container runtime '{{ container_engine | default('docker') }}' has only {{ runtime_memory_gb }}GB
      ({{ runtime_memory_mb }}MB) of memory, but Kagenti requires at least {{ kind_min_memory_gb }}GB.
      Please increase the memory allocation in {{ container_engine | default('docker') }} settings
      and restart.
      Without sufficient memory, components like cert-manager and Istio will fail to start.
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))
    - runtime_memory_gb is defined
    - (runtime_memory_gb | float) < (kind_min_memory_gb | float)

- name: Preflight - Fail if container runtime has insufficient CPUs
  fail:
    msg: >-
      Container runtime '{{ container_engine | default('docker') }}' has only {{ runtime_cpus }} CPUs,
      but Kagenti requires at least {{ kind_min_cpus }}.
      Please increase the CPU allocation in {{ container_engine | default('docker') }} settings
      and restart.
  when:
    - create_kind_cluster | default(false)
    - not (enable_openshift | default(false))
    - runtime_cpus is defined
    - (runtime_cpus | int) < (kind_min_cpus | int)
